<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <title><%= htmlWebpackPlugin.options.title %></title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-164909144-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-164909144-2');
    </script>
  </head>
  <body style="margin:0;">
    <div style="width: 100vw;
    height: 100vh;
    background: url(assets/images/campfire.jpg);
    background-size: cover;
    background-position: center;" id="root"></div>  
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function(){
        var messageQueue = [];
        var iFrameLoaded = false;
        // Assign handler to message event
        if ( window.addEventListener ) {
            window.addEventListener('message', handleMessage, false);
        } else if ( window.attachEvent ) { // ie8
            window.attachEvent('onmessage', handleMessage);
        }
        function handleMessage (event) {
          if(!(event.origin === "https://remotely-voice-server.australiaeast.cloudapp.azure.com" ||
          event.origin === "https://dev-remotely-server.australiaeast.cloudapp.azure.com" || 
          event.origin === "https://remotely-meeting-rooms.azurefd.net" || 
          event.origin === "https://remotely-meeting.australiaeast.cloudapp.azure.com" )
          ){
            return;
          }
          if(event.data && event.data.length > 0){
            if(event.data[0] == "packet"){
              if(window.connector){
                while (messageQueue.length > 0) {
                  window.connector.sendPacket(messageQueue.pop());
                }
                window.connector.sendPacket(event.data[1]);
              }else{
                messageQueue.push(event.data[1])
              }
            }else if(event.data[0] == "loaded"){
              iFrameLoaded=true;
              sendToIframe("","");
            }
          }
        };
        function sendToIframe(method, data){
          if(!window.gameframe){
            window.gameframe = document.getElementsByTagName("iframe")[0].contentWindow;
          }
          if(!iFrameLoaded){
            if(method.length == 0) return;
            messageQueue.push({'method':method,'data':data});
          }else{
            while(messageQueue.length > 0){
              let poped =  messageQueue.shift();
              window.gameframe.postMessage(JSON.stringify({'method':poped['method'],'parameters':poped['data']}),'*');
            }
            if(method.length == 0) return;
            window.gameframe.postMessage(JSON.stringify({'method':method,'parameters':data}),'*');
          }
        }
        window.sendtoiframe = sendToIframe;
      });
    </script>
  </body>
</html>

<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <title><%= htmlWebpackPlugin.options.title %></title>
  </head>
  <body>
    <div id="root"></div>  
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function(){
        var messageQueue = [];
        var iFrameLoaded = false;
        // Assign handler to message event
        if ( window.addEventListener ) {
            window.addEventListener('message', handleMessage, false);
        } else if ( window.attachEvent ) { // ie8
            window.attachEvent('onmessage', handleMessage);
        }
        function handleMessage (event) {
          if((event.origin !== "https://remotely-voice-server.australiaeast.cloudapp.azure.com" || (!!event.data && !!event.data.source && event.data.source.includes("react"))) ||
          (event.origin !== "https://dev-remotely-server.australiaeast.cloudapp.azure.com" || (!!event.data && !!event.data.source && event.data.source.includes("react"))) ||
          (event.origin !== "https://remotely-meeting-rooms.azurefd.net" || (!!event.data && !!event.data.source && event.data.source.includes("react"))) ||
          (event.origin !== "https://remotely-meeting.australiaeast.cloudapp.azure.com" || (!!event.data && !!event.data.source && event.data.source.includes("react")))
          ){
            return;
          }
          if(!!event && !!event.length > 0){
            if(event[0] == "packet"){
              if(window.connector){
                while (messageQueue.length > 0) {
                  window.connector.sendPacket(messageQueue.pop());
                }
                window.connector.sendPacket(event[1]);
              }else{
                messageQueue.push(event[1])
              }
            }else if(event[0] == "loaded"){
              iFrameLoaded=true;
              console.log("Loaded game");
              sendToIframe("","");
            }
          }
        };
        function sendToIframe(method, data){
          console.log("Getting send to iframe : ",method, data);
          if(!window.gameframe){
            window.gameframe = document.getElementsByTagName("iframe")[0].contentWindow;
          }
          if(!iFrameLoaded){
            if(method.length == 0) return;
            console.log("Pushing method onto message queue");
            messageQueue.push({'method':method,'data':data});
          }else{
            while(messageQueue.length > 0){
              let poped =  messageQueue.pop();
              console.log("Popping event ", poped);
              window.gameframe.postMessage(JSON.stringify({'method':poped['method'],'parameters':poped['data']}),'*');
            }
            if(method.length == 0) return;
            window.gameframe.postMessage(JSON.stringify({'method':method,'parameters':data}),'*');
          }
        }
        window.sendtoiframe = sendToIframe;
      });
    </script>
  </body>
</html>
